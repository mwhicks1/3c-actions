# This file is generated by generate-workflow.py. To update this file, update
# generate-workflow.py instead and re-run it. Some things in this file are
# explained by comments in generate-workflow.py.

name: 3C benchmark tests

on:
  # Run every day at 3:00 AM EDT (i.e., 7 am UTC)
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch or commit ID of correctcomputation/checkedc-clang to run workflow on"
        required: true
        default: "main"

env:
  benchmark_tar_dir: "/home/github/checkedc-benchmarks"
  builddir: "${{github.workspace}}/b/ninja"
  benchmark_conv_dir: "${{github.workspace}}/benchmark_conv"
  branch_for_scheduled_run: "main"
  include_dir: "${{github.workspace}}/depsfolder/checkedc-clang/llvm/projects/checkedc-wrapper/checkedc/include"
  port_tools: "${{github.workspace}}/depsfolder/checkedc-clang/clang/tools/3c/utils/port_tools"

jobs:

  # Cleanup files left behind by prior runs
  clean:
    name: Clean
    runs-on: self-hosted
    steps:
      - name: Clean
        run: |
          rm -rf ${{env.benchmark_conv_dir}}
          mkdir -p ${{env.benchmark_conv_dir}}
          rm -rf ${{env.builddir}}
          mkdir -p ${{env.builddir}}
          rm -rf ${{github.workspace}}/depsfolder
          mkdir -p ${{github.workspace}}/depsfolder

  # Clone and build 3c and clang
  # (clang is needed to test compilation of converted benchmarks.)
  build_3c:
    name: Build 3c and clang
    needs: clean
    runs-on: self-hosted
    steps:
      - name: Check out the actions repository
        uses: actions/checkout@v2
        with:
          path: depsfolder/actions
      - name: Check that the workflow file is up to date with generate-workflow.py before running it
        run: |
          cd ${{github.workspace}}/depsfolder/actions
          ./generate-workflow.py
          git diff --exit-code

      - name: Branch or commit ID
        run: echo "${{ github.event.inputs.branch || env.branch_for_scheduled_run }}"
      - name: Check out the 3C repository and the Checked C system headers
        run: |
          git init ${{github.workspace}}/depsfolder/checkedc-clang
          cd ${{github.workspace}}/depsfolder/checkedc-clang
          git remote add origin https://github.com/correctcomputation/checkedc-clang
          git fetch --depth 1 origin "${{ github.event.inputs.branch || env.branch_for_scheduled_run }}"
          git checkout FETCH_HEAD
          git clone --depth 1 https://github.com/microsoft/checkedc ${{github.workspace}}/depsfolder/checkedc-clang/llvm/projects/checkedc-wrapper/checkedc

      - name: Build 3c and clang
        run: |
          cd ${{env.builddir}}
          # We'll be running the tools enough that it's worth spending the extra
          # time for an optimized build, and the easiest way to do that is to
          # use a "release" build. But we do want assertions and we do want
          # debug info in order to get symbols in assertion stack traces, so we
          # use -DLLVM_ENABLE_ASSERTIONS=ON and the RelWithDebInfo build type,
          # respectively. Furthermore, the tools rely on the llvm-symbolizer
          # helper program to actually read the debug info and generate the
          # symbolized stack trace when an assertion failure occurs. We could
          # build it here, but as of 2021-03-15, we just use Ubuntu's version
          # installed systemwide; it seems that llvm-symbolizer is a generic
          # tool and the difference in versions does not matter.
          cmake -G Ninja \
            -DLLVM_TARGETS_TO_BUILD=X86 \
            -DCMAKE_BUILD_TYPE="RelWithDebInfo" \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DLLVM_OPTIMIZED_TABLEGEN=ON \
            -DLLVM_USE_SPLIT_DWARF=ON \
            -DLLVM_ENABLE_PROJECTS="clang" \
            ${{github.workspace}}/depsfolder/checkedc-clang/llvm
          # -l 36: Try not to overload gamera. Hopefully this will use all 36
          # hyperthreads when nothing else is running and automatically scale
          # back when other jobs are running. TODO: Better solution?
          ninja -l 36 3c clang
          chmod -R 777 ${{github.workspace}}/depsfolder
          chmod -R 777 ${{env.builddir}}

  # Run Test for 3C
  test_3c:
    name: 3C regression tests
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: 3C regression tests
        run: |
          cd ${{env.builddir}}
          ninja check-3c

  # Convert our benchmark programs

  test_vsftpd_no_alltypes:
    name: Test Vsftpd (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build Vsftpd
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/vsftpd-3.0.3.tar.gz
          cd vsftpd-3.0.3
          bear make CC="${{env.builddir}}/bin/clang -Wno-enum-conversion"

      - name: Convert Vsftpd
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/vsftpd-3.0.3
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted Vsftpd
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/vsftpd-3.0.3
          make CC="${{env.builddir}}/bin/clang -Wno-enum-conversion" -k

  test_ptrdist_no_alltypes:
    name: Test PtrDist (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build PtrDist
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/ptrdist-1.1.tar.gz
          cd ptrdist-1.1
          for i in anagram bc ft ks yacr2 ; do \
            (cd $i ; bear make CC="${{env.builddir}}/bin/clang" LOCAL_CFLAGS="-D_ISOC99_SOURCE") \
          done

      - name: Convert anagram
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/anagram
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted anagram
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/anagram
          make CC="${{env.builddir}}/bin/clang" -k LOCAL_CFLAGS="-D_ISOC99_SOURCE"

      - name: Convert bc
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/bc
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted bc
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/bc
          make CC="${{env.builddir}}/bin/clang" -k LOCAL_CFLAGS="-D_ISOC99_SOURCE"

      - name: Convert ft
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/ft
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted ft
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/ft
          make CC="${{env.builddir}}/bin/clang" -k LOCAL_CFLAGS="-D_ISOC99_SOURCE"

      - name: Convert ks
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/ks
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted ks
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/ks
          make CC="${{env.builddir}}/bin/clang" -k LOCAL_CFLAGS="-D_ISOC99_SOURCE"

      - name: Convert yacr2
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/yacr2
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted yacr2
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/ptrdist-1.1/yacr2
          make CC="${{env.builddir}}/bin/clang" -k LOCAL_CFLAGS="-D_ISOC99_SOURCE"

  test_libarchive_no_alltypes:
    name: Test LibArchive (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build LibArchive
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/libarchive-3.4.3.tar.gz
          cd libarchive-3.4.3
          cd build
          cmake -DCMAKE_C_COMPILER=${{env.builddir}}/bin/clang -DCMAKE_C_FLAGS="-w -D_GNU_SOURCE" ..
          bear make

      - name: Convert LibArchive
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/libarchive-3.4.3
          ${{env.port_tools}}/convert_project.py \
            --skip '/.*/(test|test_utils|tar|cat|cpio|examples|contrib|libarchive_fe)/.*' \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path . \
            --build_dir build

      - name: Build converted LibArchive
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/libarchive-3.4.3
          cd build
          make -k

  test_lua_no_alltypes:
    name: Test Lua (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build Lua
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/lua-5.4.1.tar.gz
          cd lua-5.4.1
          bear make CC="${{env.builddir}}/bin/clang" linux
          ( cd src ; \
            clang-rename-10 -pl -i \
              --qualified-name=main \
              --new-name=luac_main \
              luac.c )

      - name: Convert Lua
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/lua-5.4.1
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted Lua
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/lua-5.4.1
          make CC="${{env.builddir}}/bin/clang" -k linux

  test_libtiff_no_alltypes:
    name: Test LibTiff (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build LibTiff
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/tiff-4.1.0.tar.gz
          cd tiff-4.1.0
          cmake -DCMAKE_C_COMPILER=${{env.builddir}}/bin/clang -DCMAKE_C_FLAGS="-w" .
          bear make tiff
          ( cd tools ; \
            for i in *.c ; do \
              clang-rename-10 -pl -i \
                --qualified-name=main \
                --new-name=$(basename -s .c $i)_main $i ; \
            done)

      - name: Convert LibTiff
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/tiff-4.1.0
          ${{env.port_tools}}/convert_project.py \
            --skip '/.*/tif_stream.cxx' \
            --skip '.*/test/.*\.c' \
            --skip '.*/contrib/.*\.c' \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted LibTiff
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/tiff-4.1.0
          make -k tiff

  test_zlib_no_alltypes:
    name: Test ZLib (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build ZLib
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/zlib-1.2.11.tar.gz
          cd zlib-1.2.11
          mkdir build
          cd build
          cmake -DCMAKE_C_COMPILER=${{env.builddir}}/bin/clang -DCMAKE_C_FLAGS="-w" ..
          bear make

      - name: Convert ZLib
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/zlib-1.2.11
          ${{env.port_tools}}/convert_project.py \
            --skip '/.*/test/.*' \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path . \
            --build_dir build

      - name: Build converted ZLib
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/zlib-1.2.11
          cd build
          make -k

  test_icecast_no_alltypes:
    name: Test Icecast (no -alltypes)
    needs: build_3c
    runs-on: self-hosted
    steps:
      - name: Build Icecast
        run: |
          mkdir -p ${{env.benchmark_conv_dir}}/no-alltypes
          cd ${{env.benchmark_conv_dir}}/no-alltypes
          tar -xvzf ${{env.benchmark_tar_dir}}/icecast-2.4.4.tar.gz
          cd icecast-2.4.4
          CC="${{env.builddir}}/bin/clang" ./configure
          bear make

      - name: Convert Icecast
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/icecast-2.4.4
          ${{env.port_tools}}/convert_project.py \
            -dr \
            --includeDir ${{env.include_dir}} \
            --prog_name ${{env.builddir}}/bin/3c \
            --project_path .

      - name: Build converted Icecast
        run: |
          cd ${{env.benchmark_conv_dir}}/no-alltypes/icecast-2.4.4
          make -k
